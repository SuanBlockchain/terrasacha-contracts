# The manifest for the "api" service.
# Read the full specification for the "Request-Driven Web Service" type at:
# https://aws.github.io/copilot-cli/docs/manifest/rd-web-service/

# Your service name will be used in naming your resources like log groups, App Runner services, etc.
name: api
# The "architecture" of the service you're running.
type: Request-Driven Web Service

image:
  # Docker build arguments.
  # For additional overrides: https://aws.github.io/copilot-cli/docs/manifest/rd-web-service/#image-build
  build: Dockerfile
  # Port exposed through your container to route traffic to it.
  port: 8000

http:
  healthcheck:
    path: /
    healthy_threshold: 1
    unhealthy_threshold: 3
    interval: 10s
    timeout: 5s

# Number of CPU units for the task.
cpu: 1024
# Amount of memory in MiB used by the task.
memory: 2048

# Environment variables (non-sensitive configuration)
variables:
  # Application Environment
  ENVIRONMENT: production
  API_PORT: "8000"

  # Cardano Network Configuration
  network: testnet  # Change to 'mainnet' for production

  # JWT Configuration
  JWT_ALGORITHM: HS256
  WALLET_SESSION_TIMEOUT_MINUTES: "30"
  WALLET_REFRESH_TOKEN_DAYS: "7"

  # Database Configuration
  # Note: DB_SECRET contains host, username, password, port, and dbname
  # Your application should parse the DB_SECRET JSON to get connection details
  POSTGRES_DB: terrasacha_db

  # Multi-Tenant Configuration
  USE_MULTI_TENANT: "true"

# Sensitive values stored in AWS Secrets Manager
secrets:
  # API Security
  API_KEY_DEV: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/api_key_dev
  JWT_SECRET_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/jwt_secret_key

  # Cardano Blockfrost API
  blockfrost_api_key: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/blockfrost_api_key

  # Aurora Database Credentials (legacy - for PostgreSQL)
  DB_SECRET:
    from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-apiclusterAuroraSecret

  # MongoDB Multi-Tenant Configuration
  # Admin database (stores tenant registry and API key mappings)
  MONGODB_ADMIN_URI: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/mongodb_admin_uri

  # Tenant-specific MongoDB URIs
  # Add one secret per tenant: MONGODB_URI_<TENANT_ID>
  MONGODB_URI_DEFAULT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/mongodb_uri_default
  # MONGODB_URI_CLIENT_A: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/mongodb_uri_client_a
  # MONGODB_URI_CLIENT_B: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/mongodb_uri_client_b
  # Add more tenant URIs as needed...

# Connect your App Runner service to your environment's VPC (required for Aurora).
network:
  vpc:
    placement: private

# Enable tracing for the service.
# observability:
#   tracing: awsxray

# You can override any of the values defined above by environment.
# environments:
#   test:
#     variables:
#       LOG_LEVEL: debug        # Log level for the "test" environment.